---
title: "COVID Expression Analysis"
author: "Rachel Kwan and Jonathan Zaslavsky"
date: "01/06/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Relevant Packages
```{r, message = FALSE, warning = FALSE}
# Load packages
library(here) # To read in data from directory
library(tidyverse) # For ggplot2, dplyr
library(magrittr) # For set_colnames() and set_rownames()
library(ggpubr) # For making publication-ready plots based on ggplot
library(RSKC) # For RSKC clustering
library(Rtsne) # To run t-SNE (dimensionality reduction)

# Set the seed
set.seed(72613)
```

## Import and Prepare Dataset
```{r}
# Load full dataset
all_fidelity <- read.csv(here("Data", "COVID Data - 28 Genes - 1281 Samples from 16 Regions - No Transformation.csv"))
```

## Perform Robust and Sparse K-Means Clustering (RSKC) and t-SNE Together

This while loop contains sections for RSKC, elbow plot, obtaining weighted data, and tSNE. Dezi's code was used as template for this while loop, in particular, for the RSKC and tSNE sections.

```{r}
set.seed(72613)

while (T) {
  
  # Assign desired number of clusters to 'clust_vect'.
  clust_vect <- c(3,4,5,6)
  
  # Assign an empty list to 'rskc_list'.
  rskc_list <- list()
  
  # Assign 8 colours to 'col_vect'.
  col_vect <- c("#FF0000",
                "#0000FF",
                "#00FF00",
                "#A020F0",
                "#FFA500",
                "#FFFF00",
                "#A65628",
                "#F781BF")
  
  # Assign a value of 0 to 'counter'.
  counter <- 0
  
  # Assign an empty list to 'tsne_list'.
  tsne_list <- list()
  
  # Assign an empty list to 'weight_list'.
  weight_list <- list()
  
  # For 'i' -- the current number of clusters -- in 'clust_vect'...
  for (i in clust_vect) {
    # i = 2
    # Increment 'counter' with a value of 1.
    counter = counter + 1
    
    ###### RSKC ######
    
    # Perform RSKC for whatever-the-value-of-'i'-is many clusters using 
    # 'myFidelity', which has brain region as rows and gene_celltype as columns.
    # Assign RSKC's output as an entry in 'rskc_list'. 
    rskc_list[[counter]] <- RSKC(myFidelity, 
                                 ncl = i,
                                 alpha = 0.1,
                                 L1 = sqrt(ncol(myFidelity)))
    
    
    # Convert the row names of 'myFidelity' to a column
    # called 'Brain.Region' and store it in 'gene_and_region'.
    gene_and_region <- myFidelity %>% 
      rownames_to_column("Brain.Region")
    
    # For the current object in 'rskc_list' convert the cluster labels
    # into characters, and assign them to a new column called 'cluster_labels'
    # in 'gene_and_region'.  
    gene_and_region$cluster_labels <- rskc_list[[counter]]$labels %>% 
      as.character()
    
    # Order the weights for the current item in 'rskc_list' from largest
    # to smallest, extract the names of the genes in this order,
    # convert this object into a data frame, and store this info in
    # an object 'weight_df' in a column called 'gene'.
    weight_df <- sort(rskc_list[[counter]]$weights, 
                      decreasing = T) %>% 
      names() %>% 
      as.data.frame() %>% 
      rename('gene' = ".")
    
    # Assign the ordered weights for the current item in 'rskc_list' into
    # 'weight_df', in a column called 'weight', 
    weight_df$weight <- sort(rskc_list[[counter]]$weights,
                             decreasing = T) %>%
      unname() 
    
    # Impose a factor order on the contents of 'weight_df$gene' in 
    # the current order. 
    weight_df$gene <- factor(weight_df$gene,
                             weight_df$gene)
    
    # Create a bar graph of the RSKC weights for each gene ordered from
    # largest to smallest. Assign this graph to an object, 'weight_bars'.
    weight_bars <- weight_df %>% 
      ggplot(aes(x = gene, y = weight)) + 
      theme_classic() +
      geom_bar(stat = 'identity') +
      theme(axis.text.x = element_text(angle = 45, vjust = 0.6)) +
      scale_y_continuous(expand = c(0,0)) +
      ggtitle(paste0("RSKC Weights for K = ",i)) +
      xlab("") +
      ylab("Weights\n")
    
    # Assign 'weight_bars' as the current entry into 'weight_list'. 
    weight_list[[counter]] <- weight_bars
    
    ###### Apply weights from RSKC to myFidelity ######
    
    # Create vector of the weights obtained from RSKC and assign them to 'weights'.
    # Make empty matrix 'weighted_fidelity' for new weighted fidelity scores.
    weights <- as.matrix(rskc_list[[1]]$weights)
    weighted_fidelity <- matrix(nrow = 18, ncol = 20)
    
    # Multiply 'myFidelity' by corresponding weights obtained from RSKC.
    for (n in 1:20){
      weighted_fidelity[,n] <- myFidelity[,n]*weights[n]
    }
    
    ###### tSNE (on weighted data) ######
    
    # Run tsne on weighted fidelity scores, and assign to 'tsne'
    set.seed(72613)
    tsne <- Rtsne(weighted_fidelity, perplexity = 5)
    
    # Create new df 'tsne_out' which contains the two dimensions obtained from tSNE
    # and corresponding regions
    tsne_out <- tsne$Y %>%
      data.frame(regions) %>%
      rename(Brain.Region = regions, V1 = X1, V2 = X2) #rename columns
    
    # Merge 'tsne_out' with 'gene_and_region' according
    # to their shared 'Brain.Region' column, and assign to 
    # 'tsne_genes_regions_clusts'. 
    tsne_genes_regions_clusts <- merge(tsne_out,
                                       gene_and_region,
                                       by = "Brain.Region")
    
    # Create a tSNE scatter plot where each point is colour-coded according to
    # its designated RSKC cluster and assign this figure to 'tsne_scatter'.
    tsne_scatter <- ggplot(tsne_genes_regions_clusts,
                           aes(V1,
                               V2,
                               fill = cluster_labels)) +
      geom_point(shape = 21, size = 3) + 
      scale_fill_manual(values = col_vect[1:i],
                        labels = 1:i,
                        name = "Cluster") +
      theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            panel.background = element_rect(fill = NA, 
                                            colour = "white"),
            panel.border = element_blank(),
            axis.line = element_line(),
            legend.position = 'bottom',
            legend.background = element_rect(fill = NA,
                                             colour = NA), 
            legend.title.align=0.5) +
      guides(fill=guide_legend(nrow = 2,
                               ncol = 4, 
                               byrow = TRUE)) +
      labs(x="V1", y="V2") 
    
    # Assign 'tsne_scatter' as an entry in 'tsne_list'.
    tsne_list[[counter]] <- tsne_scatter
    
  }
  
  # Break out of the while-loop when for-loop is done. 
  break
  
}
```

```{r, fig.align = 'center', fig.height = 6, fig.width = 6}
# Make figures for all the plots obtained from the while loop above
# i.e. the RSKC scatter plots, the RKSC weights, and elbow plot
ggarrange(tsne_list[[1]], tsne_list[[2]],
          tsne_list[[3]], tsne_list[[4]],
          ncol = 2,
          nrow = 2)
```

```{r, fig.align = 'center', fig.height = 12, fig.width = 16}
ggarrange(weight_list[[1]], weight_list[[2]],
          weight_list[[3]], weight_list[[4]],
          ncol = 2,
          nrow = 2)
```

\newpage

## RSKC (10 Runs)

This chunk serves as a snapshot of the RSKC over 10 runs (i.e. different set.seed values) in order to visualize the variation in cluster label assignments for each observation. The 10 runs were carried out for each of $K = 3, 4, 5$.


```{r}
set.seed(72613)

while (T) {
  
  # Assign the values of 5, 6, 7 to 'clust_vect'.
  clust_vect <- c(3,4,5,6)
  
  # Assign empty lists to 'rskc.results.list' and 'rskc.weighted.list'
  # to store the results and the RSKC weighted data frames that result
  # from the clustering.
  rskc_results_list = list()
  rskc_weighted_list = list()
  
  # Assign 7 colours to 'col_vect'.
  col_vect <- c("#FF0000",
                "#0000FF",
                "#00FF00",
                "#A020F0",
                "#FFA500",
                "#FFFF00",
                "#A65628")
  
  # Assign an empty list to 'tsne_list_5', 'tsne_list_6', and 'tsne_list_7'.
  tsne_list_3 <- list()
  tsne_list_4 <- list()
  tsne_list_5 <- list()
  tsne_list_6 <- list()
  
  # Assign an empty list to 'weight_list'.
  weight_list <- list()
  
  # Create empty data frames to store the cluster assignments and cluster weights 
  # for each of the 10 runs.
    rskc_region_labels_3 = data.frame("Region" = rownames(myFidelity))
    rskc_region_labels_4 = data.frame("Region" = rownames(myFidelity))
    rskc_region_labels_5 = data.frame("Region" = rownames(myFidelity))
    rskc_region_labels_6 = data.frame("Region" = rownames(myFidelity))
    rskc_region_weights = data.frame("Case" = colnames(myFidelity))
    
  # For 'i' -- the current number of clusters -- in 'clust_vect'...
  for (i in clust_vect) {
    
    ###### RSKC (10 Runs) ######
    
    # Create a vector of seeds for all 10 runs.
    set.seed(72613)
    x = rdunif(10, a = 1, b = 1000000)
    
    for (counter in 1:10) {
      
      # Set the seed.
      set.seed(x[counter])
      
      # Perform RSKC for whatever-the-value-of-''-is many clusters using 
      # 'myFidelity', which has brain region as rows and gene_celltype as columns.
      # Assign RSKC's output as an entry in 'rskc_results_list'.
      rskc_results_list[[counter]] <- RSKC(myFidelity, 
                                           alpha = 0.1, 
                                           ncl = i, 
                                           L1 = sqrt(ncol(myFidelity)))
      
      # Use the following if statements to add the cluster assignments for run i to 
      # the corresponding 'rskc_region_labels_3', 'rskc_region_labels_4' or 'rskc_region_labels_5'.
      if (i == 3){
        rskc_region_labels_3[counter+1] <- rskc_results_list[[counter]]$labels
        colnames(rskc_region_labels_3)[counter+1] <- paste("Run_", counter, sep = "")
      }
      
      if (i == 4){
        rskc_region_labels_4[counter+1] <- rskc_results_list[[counter]]$labels
        colnames(rskc_region_labels_4)[counter+1] <- paste("Run_", counter, sep = "")
      }
      
      if (i == 5){
        rskc_region_labels_5[counter+1] <- rskc_results_list[[counter]]$labels
        colnames(rskc_region_labels_5)[counter+1] <- paste("Run_", counter, sep = "")
      }
      
      if (i == 6){
        rskc_region_labels_6[counter+1] <- rskc_results_list[[counter]]$labels
        colnames(rskc_region_labels_6)[counter+1] <- paste("Run_", counter, sep = "")
      }
      
      # Add the variable weights for run i to the 'rskc_region_weights'
      rskc_region_weights[counter+1] <- rskc_results_list[[counter]]$weights
      colnames(rskc_region_weights)[counter+1] <- paste("Run_", counter, sep = "")
      
      # For the current object in 'rskc_list' convert the cluster labels
      # into characters, and assign them to a new column called 'cluster_labels'
      # in 'fidelity'.  
      fidelity$cluster_labels <- rskc_results_list[[counter]]$labels %>% 
        as.character()
     
      ###### Apply weights from RSKC to myFidelity ######
      
      # Create vector of the weights obtained from RSKC and assign them to 'weights'.
      # Make empty matrix 'weighted_fidelity' for new weighted fidelity scores.
      weights <- as.matrix(rskc_results_list[[1]]$weights)
      
      # Multiply 'fidelity' columns containing gene_celltype by corresponding 
      # weights obtained from RSKC.
      weighted_fidelity <- sweep(t(fidelity[,2:(ncol(fidelity)-1)]), MARGIN = 1, weights, `*`) %>% 
        t()
      
      ###### tSNE (on weighted data) ######
      
      # Run tsne on weighted fidelity scores, and assign to 'tsne'
      set.seed(72613)
      tsne <- Rtsne(weighted_fidelity, perplexity = 5)
      
      # Create new df 'tsne_out' which contains the two dimensions obtained from tSNE
      # and corresponding regions
      tsne_out <- tsne$Y %>%
        data.frame(regions) %>%
        rename(Brain.Region = regions, V1 = X1, V2 = X2) #rename columns
      
      # Merge 'tsne_out' with 'fidelity' according
      # to their shared 'Brain.Region' column, and assign to 
      # 'tsne_genes_regions_clusts'. 
      tsne_genes_regions_clusts <- merge(tsne_out,
                                         fidelity,
                                         by = "Brain.Region")
      
      # Create a tSNE scatter plot where each point is colour-coded according to
      # its designated RSKC cluster and assign this figure to 'tsne_scatter'.
      tsne_scatter <- ggplot(tsne_genes_regions_clusts,
                             aes(V1,
                                 V2,
                                 fill = cluster_labels)) +
        geom_point(shape = 21, size = 3) + 
        scale_fill_manual(values = col_vect[1:i],
                          labels = 1:i,
                          name = "Cluster") +
        theme(axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              panel.background = element_rect(fill = NA, 
                                              colour = "white"),
              panel.border = element_blank(),
              axis.line = element_line(),
              legend.position = 'bottom',
              legend.background = element_rect(fill = NA,
                                               colour = NA), 
              legend.title.align=0.5) +
        guides(fill=guide_legend(nrow = 2,
                                 ncol = 4, 
                                 byrow = TRUE)) +
        labs(x="V1", y="V2") 
      
      # Use if statements to assign 'tsne_scatter' as an entry in 'tsne_list_3',
      # 'tsne_list_4', or 'tsne_list_5' depending on the current i.
      if (i == 3){
        tsne_list_3[[counter]] <- tsne_scatter
      }
      
      if (i == 4){
        tsne_list_4[[counter]] <- tsne_scatter
      }
      
      if (i == 5){
        tsne_list_5[[counter]] <- tsne_scatter
      }
      
      if (i == 6){
        tsne_list_6[[counter]] <- tsne_scatter
      }
      
    } 
    
  }
  
  # Break out of the while-loop when for-loop is done. 
  break
  
}
```

```{r, echo = FALSE, fig.align = 'center', fig.height = 14, fig.width = 6}
# Create 5x2 figure for the 10 scatter plots using K = 5 for RSKC.
ggarrange(tsne_list_3[[1]], tsne_list_3[[2]],
          tsne_list_3[[3]], tsne_list_3[[4]],
          tsne_list_3[[5]], tsne_list_3[[6]],
          tsne_list_3[[7]], tsne_list_3[[8]],
          tsne_list_3[[9]], tsne_list_3[[10]],
          ncol = 2,
          nrow = 5)
```

```{r, echo = FALSE, fig.align = 'center', fig.height = 14, fig.width = 6}
# Create 5x2 figure for the 10 scatter plots using  K = 3 for RSKC.
ggarrange(tsne_list_4[[1]], tsne_list_4[[2]],
          tsne_list_4[[3]], tsne_list_4[[4]],
          tsne_list_4[[5]], tsne_list_4[[6]],
          tsne_list_4[[7]], tsne_list_4[[8]],
          tsne_list_4[[9]], tsne_list_4[[10]],
          ncol = 2,
          nrow = 5)
```

```{r, echo = FALSE, fig.align = 'center', fig.height = 14, fig.width = 6}
# Create 5x2 figure for the 10 scatter plots using  K = 3 for RSKC.
ggarrange(tsne_list_5[[1]], tsne_list_5[[2]],
          tsne_list_5[[3]], tsne_list_5[[4]],
          tsne_list_5[[5]], tsne_list_5[[6]],
          tsne_list_5[[7]], tsne_list_5[[8]],
          tsne_list_5[[9]], tsne_list_5[[10]],
          ncol = 2,
          nrow = 5)
```

```{r, echo = FALSE, fig.align = 'center', fig.height = 14, fig.width = 6}
# Create 5x2 figure for the 10 scatter plots using K = 4 for RSKC.
ggarrange(tsne_list_6[[1]], tsne_list_6[[2]],
          tsne_list_6[[3]], tsne_list_6[[4]],
          tsne_list_6[[5]], tsne_list_6[[6]],
          tsne_list_6[[7]], tsne_list_6[[8]],
          tsne_list_6[[9]], tsne_list_6[[10]],
          ncol = 2,
          nrow = 5)
```

